<!DOCTYPE html>
<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=Edge;chrome=1' >
  <title>IATI CSV Conversion tool: Map your dimensions</title>
  <link rel='stylesheet' href='css/forms.css'>
  <link rel='stylesheet' href='css/style.css'>
</head>
<body>
<div id="model_page_view">
  <div class="banner" style="width:100%;color:#365e93;">
  <h1>IATI CSV Conversion tool: Map your dimensions</h1>
  </div>
  <div id="right_pane" style="float:right;width:28%;position:fixed;left:71%;">
      <div id="columns">
        <p>Available columns in your data:</p>
        <ul>
        </ul>
      </div>
      <div id="iatifields">
        <p>Available IATI fields:</p>
        <ul></ul>
      </div>
      <textarea id="debug" style='display:none;' readonly>
      </textarea>
  </div>
  <div class='content' style='width: 70%'>
    <div id='m1' class='modeleditor'>
      <div class='steps'>
        <ul>
          <li><a href='#'><span>1</span> Organisation information</a></li>
          <li>
            <a href='#'><span>2</span> Dimension mapping</a>
            <ul class='steps_dimensions'>
            </ul>
          </li>
          <li><a href='#'><span>3</span> Convert</a></li>
        </ul>
      <div class="modeltoggle"><a href="#" id="showdebug">Show model</a></div>
      </div>
      <div class='forms'>
        <form action='#'>
          <!-- Dataset metadata -->
          <div class='formpart'>
            <h2>Organisation information</h2>
            <p>First, we need to collect some basic information about your organisation. You need to know:</p>
            <ul>
                <li>Your organisation name</li>
                <li>Your organisation's charity or company registration number (or equivalent)</li>
                <li>The currency of your data</li>
                <li>The language of your data</li>
            </ul>
            <dl>
              <fieldset id="reporting-org">
                  <legend>Your Organisation</legend>
                  <dt><label for='organisation[reporting-org][name]'>Name:</label></dt>
                  <dd><input type='text' name='organisation[reporting-org][name]'></dd>
                  <dd class='hints'>
                    The name of the organisation reporting this data. Examples: <code>Department for International Development</code>,
                    <code>Oxfam GB</code>, <code>United Nations Development Programme</code>.
                  </dd>
                  <dt><label for='organisation[reporting-org][ref]'>Ref:</label></dt>
                  <dd><input type='text' name='organisation[reporting-org][ref]'></dd>
                  <dd class='hints'>
                    A unique reference for this organisation. If this organisation is a registered charity or company, use the jurisidiction, followed by the registration body, followed by the registration code. Examples: <code>CA-CRA-89980-1815-RR0001</code> (Engineers Without Borders Canada),
                    <code>GB-CHC-202918</code> (Oxfam GB).
                  </dd>
                  <dt><label for='organisation[reporting-org][type]'>Type:</label></dt>
                  <dd><input type='text' name='organisation[reporting-org][type]'></dd>
                  <dd class='hints'>
                    The type of organisation. Examples: <code>21</code> (INGO, e.g. Oxfam GB).
                  </dd>
              </fieldset>
              <fieldset id="other-org">
              <legend>Basic information</legend>
                  <dt><label for='organisation[default-currency]'>Currency:</label></dt>
                  <dd><input type='text' name='organisation[default-currency]' maxlength='3' class='short'></dd>
                  <dd class='hints'>
                    A 3-letter currency code. Examples: <code>USD</code>, <code>GBP</code>,
                    etc. See <a href='http://en.wikipedia.org/wiki/ISO_4217'>ISO 4217</a>.
                  </dd>
                  
                  <dt><label for='organisation[lang]'>Language:</label></dt>
                  <dd><input type='text' name='organisation[lang]' maxlength='2' class='short'></dd>
                  <dd class='hints'>
                    The 2-letter language code. Examples: <code>en</code>, <code>fr</code>,
                    etc. See <a href='http://en.wikipedia.org/wiki/List_of_ISO_639-1_codes'>ISO 639-1</a>.
                  </dd>
                  
                  <dt><label for='organisation[data-structure]'>Data structure:</label></dt>
                  <dd><input type='checkbox' name='organisation[data-structure]' value="multiple">Multiple rows per activity<br />
                  <dd class='hints'>
                    How is your data structured? You can have one row per activity, or multiple rows per activity. 
                    If you select 'multiple rows', the converter will use the field you specify as the iati-identifier 
                    (presumably your project ID) to group your projects together.
                  </dd>

                  <dt><label for='organisation[unique_keys]'>Unique keys:</label></dt>
                  <dd class='unique_keys_widget'></dd>
                  <dd class='hints'>
                    Every dataset needs a set of columns from the data file which will
                    <em>uniquely identify</em> any given spending entry in the data.
                  </dd>
              </fieldset>

    
            </dl>
          </div>
          <!-- Dimension mapping -->
          <div class='formpart dimensions_widget'>
            <h2>Dimension mapping</h2>
            <p>
              To convert your data to the IATI format, you need to map your columns 
              to the IATI fields to create "dimensions", the logical divisions of your dataset.
              There are several required dimensions, shown below, and you can add your own dimensions
              using the links at the bottom of the page.
            </p>
            <div class='dimensions'>
            </div>
            <p>
              <a class='add_value_dimension' href='#'>Add single-column dimension</a>
              <a class='add_compound_dimension' href='#'>Add multi-column dimension</a>
            </p>
          </div>

          <!-- Conversion screen -->
          <div class='formpart'>
            <h2>Convert</h2>
            <p>If you're ready to convert, hit "Convert" below.</p>
            <input type="submit" value="Convert">
          </div>
        </form>
      </div> <!-- /.forms -->

      <!-- Unique keys template -->
      <script id='tpl_unique_keys' type='text/x-jquery-tmpl'>
        {{if keys.length == 0}}
          <em>No dimensions available yet.</em>
        {{/if}}
        {{each(i, key) keys}}
          {{if key.used}}
            <input type='hidden' name='dataset[unique_keys][]' value='${key.name}'>
            <span class='active'>
          {{else}}
            <span>
          {{/if}}
          ${key.name}
          </span>
        {{/each}}
      </script>

      <!-- Dimension column field template -->
      <script id='tpl_dimension_field' type='text/x-jquery-tmpl'>
        <tr data-field-name='${fieldName}'>
          <td>${fieldName}</td>
          <td><select class='column' name='${prefix(fieldName)}[column]'></select></td>
          <td>
            <a href='#' class='field_switch_constant'>&rarr; constant</a>
            {{if fieldBelongsTo}}
                {{if required(fieldName, fieldBelongsTo) != true}}
                <a href='#' class='field_rm'>&times;</a>
                {{/if}}
            {{else}}
                {{if required(fieldName) != true}}
                <a href='#' class='field_rm'>&times;</a>
                {{/if}}
            {{/if}}    
          </td>
        </tr>
      </script>

      <!-- Dimension constant field template -->
      <script id='tpl_dimension_field_const' type='text/x-jquery-tmpl'>
        <tr data-field-name='${fieldName}'>
          <td>
            ${fieldName}
            <input type='hidden' name='${prefix(fieldName)}[datatype]' value='constant'>
          </td>
          <td><input type='text' name='${prefix(fieldName)}[constant]'></td>
          <td>
            <a href='#' class='field_switch_column'>&rarr; column</a>
            {{if required(fieldName) != true}}
            <a href='#' class='field_rm'>&times;</a>
            {{/if}}
          </td>
        </tr>
      </script>

      <!-- Dimension template -->
      <script id='tpl_dimension' type='text/x-jquery-tmpl'>
        <input type='hidden' name='mapping[${name}][type]' value='${data.type}'>
        {{if meta.fixedDataType}}
        <input type='hidden' name='mapping[${name}][datatype]' value='${data.datatype}'>
        {{/if}}
        <legend>${data.label}</legend>
        {{if meta.helpText}}<p>{{html meta.helpText}}</p>{{/if}}
        <dl>
            <dt><label>IATI field name:</label></dt>
            {{if !meta.fixedDataType}}
              <dd><select class='iatifield' name='mapping[${name}][iati-field]'></select></dd>
            {{else}}
              <dd>${name.dasherize()}</dd>
              <input type='hidden' name='mapping[${name}][iati-field]' value='${name.dasherize()}' class="iatifield">
            {{/if}}
          {{if data.type === 'value'}}
            <dt><label>Column:</label></dt>
            <dd>
              <select class='column' name='mapping[${name}][column]'></select>
            </dd>
            {{if !meta.fixedDataType}}
              <dt><label>Data type:</label></dt>
              <dd>
                <select name='mapping[${name}][datatype]'>
                  <option value='float'>float</option>
                  <option value='string'>string</option>
                </select>
              </dd>
            {{/if}}
          {{/if}}
          <dt><label>Label:</label></dt>
          <dd>
            <input type='text' name='mapping[${name}][label]' value='${data.label}'>
          </dd>
        </dl>
        {{if data.type == 'compound' }}
          <table class='fields'>
            <thead>
              <tr>
                <td>Attribute</td>
                <td>Column/Const</td>
                <td>&nbsp;</td>
              </tr>
            </thead>
            <tbody>
            {{each(n, f) data.fields}}
              {{if f.datatype === 'constant'}}
                {{tmpl({'fieldName': n, 'prefix': formFieldPrefix, 'required': formFieldRequired2, 'fieldBelongsTo': name}) '#tpl_dimension_field_const'}}
              {{else}}
                {{tmpl({'fieldName': n, 'prefix': formFieldPrefix, 'required': formFieldRequired2, 'fieldBelongsTo': name}) '#tpl_dimension_field'}}
              {{/if}}
            {{/each}}
            </tbody>
          </table>
          <p><a class='add_field' href='#'>Add a field</a></p>
          <p><a class='delete_dimension' href='#'>Delete this dimension</a></p>
        {{/if}}
      </script>
    </div> <!-- /.modeleditor -->
  </div> <!-- /.content -->
  <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.6/jquery.min.js'></script>
  <script src='http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js'></script>

  <script src='main.js'></script>
  <script>
    jQuery(function($) {
      var column_data=['date', 'amount', 'dept_id', 'dept_stuff', 'dept_transaction_id', 'recipient', 'something', 'nothing1'];
      var iati_data=['iati-identifier', 'title', 'description', 'sector', 'participating-organisation', 'recipient-country'];
    
      $('#model_page_view').modelEditor({
        'columns': column_data,
        'iatifields': iati_data
      });
      $('#iatifields ul').html(function() {
        var iati_to_write = '';
        $.each(iati_data, function(index, value) {
            iati_to_write = iati_to_write + '<li><a class="available" href="#">' + value + '</a>';
        });
        return iati_to_write;
      });
      $('#columns ul').html(function() {
        var columns_to_write = '';
        $.each(column_data, function(index, value) {
            columns_to_write = columns_to_write + '<li><a class="available" href="#">' + value + '</a>';
        });
        return columns_to_write;
      });
      var me = $('#m1').data('modelEditor');
      /*$('#debug').change(function () {
        me.data = JSON.parse($(this).val())
        $('#m1').trigger('modelChange')
      });
      */
    })
  </script>
  
  <div class="credits" style="width:100%;color:#333333;">
  <p>Thanks to Nick Stenning and OKFN for the original code this mapping utility is based on.</p>
  </div>
</body>
</html>
